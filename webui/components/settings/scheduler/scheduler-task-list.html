<html>
<head>
    <script type="module">
        import { store } from "/components/settings/scheduler/scheduler-store.js";
    </script>
</head>
<body>
<div x-data>
    <template x-if="$store.schedulerStore">
        <div class="scheduler-container"
             x-show="!$store.schedulerStore.isCreating && !$store.schedulerStore.isEditing">
            <div class="scheduler-header">
                <h2>Task Management</h2>
                <div class="scheduler-actions">
                    <button class="btn btn-ok" @click="$store.schedulerStore.startCreateTask()">
                        New Task
                    </button>
                </div>
            </div>

            <div class="scheduler-filters">
                <div class="scheduler-filter-group">
                    <span class="scheduler-filter-label">Type:</span>
                    <select class="scheduler-filter-select" x-model="$store.schedulerStore.filterType">
                        <option value="all">All Types</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="adhoc">Ad-hoc</option>
                        <option value="planned">Planned</option>
                    </select>
                </div>

                <div class="scheduler-filter-group">
                    <span class="scheduler-filter-label">State:</span>
                    <select class="scheduler-filter-select" x-model="$store.schedulerStore.filterState">
                        <option value="all">All States</option>
                        <option value="idle">Idle</option>
                        <option value="running">Running</option>
                        <option value="disabled">Disabled</option>
                        <option value="error">Error</option>
                    </select>
                </div>
            </div>

            <div class="scheduler-empty"
                 x-show="!$store.schedulerStore.isLoading && $store.schedulerStore.filteredTasks.length === 0"
                 x-effect="$el.style.display = (!$store.schedulerStore.isLoading && $store.schedulerStore.filteredTasks.length === 0) ? '' : 'none'">
                <div class="scheduler-empty-text">No tasks found</div>
                <button class="btn btn-ok" @click="$store.schedulerStore.startCreateTask()">Create your first task</button>
            </div>

            <table class="scheduler-task-list"
                   x-show="!$store.schedulerStore.isLoading && $store.schedulerStore.filteredTasks.length > 0"
                   x-effect="$el.style.display = (!$store.schedulerStore.isLoading && $store.schedulerStore.filteredTasks.length > 0) ? '' : 'none'">
                <thead>
                <tr>
                    <th class="col-name" @click="$store.schedulerStore.changeSort('name')">
                        Name
                        <span class="scheduler-sort-indicator"
                              x-show="$store.schedulerStore.sortField === 'name'"
                              :class="{'scheduler-sort-desc': $store.schedulerStore.sortDirection === 'desc'}">↑</span>
                    </th>
                    <th class="col-state" @click="$store.schedulerStore.changeSort('state')">
                        State
                        <span class="scheduler-sort-indicator"
                              x-show="$store.schedulerStore.sortField === 'state'"
                              :class="{'scheduler-sort-desc': $store.schedulerStore.sortDirection === 'desc'}">↑</span>
                    </th>
                    <th class="col-project">Project</th>
                    <th class="col-lastrun" @click="$store.schedulerStore.changeSort('last_run')">
                        Last Run
                        <span class="scheduler-sort-indicator"
                              x-show="$store.schedulerStore.sortField === 'last_run'"
                              :class="{'scheduler-sort-desc': $store.schedulerStore.sortDirection === 'desc'}">↑</span>
                    </th>
                    <th class="col-actions">Actions</th>
                </tr>
                </thead>
                <tbody>
                <template x-for="task in $store.schedulerStore.filteredTasks" :key="task.uuid">
                    <tr @click="$store.schedulerStore.showTaskDetail(task.uuid)">
                        <td class="col-name">
                            <span x-text="task.name"></span>
                        </td>
                        <td class="col-state">
                            <span class="scheduler-status-badge"
                                  :class="$store.schedulerStore.getStateBadgeClass(task.state)"
                                  x-text="task.state"></span>
                        </td>
                        <td class="col-project">
                            <span class="project-color-ball"
                                  :style="$store.schedulerStore.extractTaskProject(task)?.color ? { backgroundColor: $store.schedulerStore.extractTaskProject(task).color } : { border: '1px solid var(--color-border)' }"></span>
                            <span x-text="$store.schedulerStore.formatTaskProject(task)"></span>
                        </td>
                        <td class="col-lastrun" x-text="$store.schedulerStore.formatDate(task.last_run)"></td>
                        <td class="col-actions" @click.stop>
                            <div class="scheduler-task-actions">
                                <button class="scheduler-task-action"
                                        @click="$store.schedulerStore.runTask(task.uuid)" title="Run Task">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16"
                                         height="16">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                </button>
                                <button class="scheduler-task-action"
                                        @click="$store.schedulerStore.resetTaskState(task.uuid)" title="Reset State">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16"
                                         height="16">
                                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                    </svg>
                                </button>
                                <button class="scheduler-task-action"
                                        @click="$store.schedulerStore.startEditTask(task.uuid)" title="Edit Task">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16"
                                         height="16">
                                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                    </svg>
                                </button>
                                <button class="scheduler-task-action"
                                        @click="$store.schedulerStore.deleteTask(task.uuid)" title="Delete Task">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16"
                                         height="16">
                                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                </template>
                </tbody>
            </table>
        </div>
    </template>
</div>
</body>
</html>
